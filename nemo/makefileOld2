#########################################################################
# nemo makefile
# 
# Mahmoud Al Gammal
# 22/1/2004
#########################################################################

#########################################################################
# VARIABLES
#########################################################################

# output directories
BUILD_DIR	:= ./build
OBJ_DIR		:= $(BUILD_DIR)/obj
LIB_DIR		:= $(BUILD_DIR)/lib
BIN_DIR		:= $(BUILD_DIR)/bin

# include directories
INCLUDE_BASE		:= ./headers
INCLUDE_POSIX		:= $(INCLUDE_BASE)/posix


# Be includes
INCLUDE_BE		:= $(INCLUDE_BASE)/be
INCLUDE_ADDONS		:= $(INCLUDE_BE)/add-ons
INCLUDE_APP		:= $(INCLUDE_BE)/app
INCLUDE_DEVICE		:= $(INCLUDE_BE)/device
INCLUDE_DRIVERS		:= $(INCLUDE_BE)/drivers
INCLUDE_GAME		:= $(INCLUDE_BE)/game
INCLUDE_INTERFACE	:= $(INCLUDE_BE)/interface
INCLUDE_KERNEL		:= $(INCLUDE_BE)/kernel
INCLUDE_MAIL		:= $(INCLUDE_BE)/mail
INCLUDE_MEDIA		:= $(INCLUDE_BE)/media
INCLUDE_MIDI		:= $(INCLUDE_BE)/midi
INCLUDE_MIDI2		:= $(INCLUDE_BE)/midi2
INCLUDE_NET			:= $(INCLUDE_BE)/net
INCLUDE_STORAGE		:= $(INCLUDE_BE)/storage
INCLUDE_SUPPORT		:= $(INCLUDE_BE)/support
INCLUDE_TRANSLATION	:= $(INCLUDE_BE)/translation

INCLUDE_ALL_BE	:=	-I$(INCLUDE_BE) -I$(INCLUDE_ADDONS) \
					-I$(INCLUDE_APP) -I$(INCLUDE_DEVICE) \
					-I$(INCLUDE_DRIVERS) -I$(INCLUDE_GAME) \
					-I$(INCLUDE_INTERFACE) -I$(INCLUDE_KERNEL) \
					-I$(INCLUDE_MAIL) -I$(INCLUDE_MEDIA) \
					-I$(INCLUDE_MIDI) -I$(INCLUDE_MIDI2) \
					-I$(INCLUDE_NET) -I$(INCLUDE_STORAGE) \
					-I$(INCLUDE_SUPPORT) -I$(INCLUDE_TRANSLATION)

# private includes
INCLUDE_PRIVATE		:= $(INCLUDE_BASE)/private
INCLUDE_PRIVATE_APP	:= $(INCLUDE_PRIVATE)/app
# next line added by Fadi Raafat Rezk EDWARD
INCLUDE_PRIVATE_MEDIA	:= $(INCLUDE_PRIVATE)/media


INCLUDE_ALL_PRIVATE	:= -I$(INCLUDE_PRIVATE) -I$(INCLUDE_PRIVATE_APP) -I$(INCLUDE_PRIVATE_MEDIA) -I$(SRC_BASE)/servers/media

# use this to include everything
INCLUDE_ALL		:= -I$(INCLUDE_POSIX) $(INCLUDE_ALL_BE) $(INCLUDE_ALL_PRIVATE)

# source directories
SRC_BASE	:= ./src
# By Fadi and Raymond on 22-2-2004
INCLUDE_SERVER		:=$(SRC_BASE)/servers
INCLUDE_SERVER_MEDIA	:=$(INCLUDE_SERVER)/media

#########################################################################
# COMPILER FLAGS
#########################################################################

CXXFLAGS	:= -g -D__NEMO__ -DDEBUG=1 -D_REENTRANT	-Wno-multichar

#########################################################################
# TARGET all
#########################################################################

all:
	make app_server
	make input_server
	make test_app
	
#########################################################################
# TARGET libroot.so
#########################################################################

NEMO_DEP	:= 	$(INCLUDE_PRIVATE)/nemo_debug.h \
				$(INCLUDE_PRIVATE)/nemo_debug.c

LIBROOT_DEP	:=	$(INCLUDE_KERNEL)/OS.h \
				$(SRC_BASE)/kernel/libroot/os/port.cpp \
				$(SRC_BASE)/kernel/libroot/os/sem.cpp \
				$(SRC_BASE)/kernel/libroot/os/thread.cpp

LIBROOT_INCLUDES:=	-I$(INCLUDE_PRIVATE) -I$(INCLUDE_BE) -I$(INCLUDE_KERNEL) -I$(INCLUDE_SUPPORT) -I$(INCLUDE_STORAGE)

libroot: $(NEMO_DEP) $(LIBROOT_DEP)
####### compiling
	$(CXX) $(CXXFLAGS) -c -fPIC $(LIBROOT_INCLUDES) -o $(OBJ_DIR)/nemo_debug.o $(INCLUDE_PRIVATE)/nemo_debug.c
	$(CXX) $(CXXFLAGS) -c -fPIC $(LIBROOT_INCLUDES) -o $(OBJ_DIR)/port.o $(SRC_BASE)/kernel/libroot/os/port.cpp
	$(CXX) $(CXXFLAGS) -c -fPIC $(LIBROOT_INCLUDES) -o $(OBJ_DIR)/sem.o $(SRC_BASE)/kernel/libroot/os/sem.cpp
	$(CXX) $(CXXFLAGS) -c -fPIC $(LIBROOT_INCLUDES) -o $(OBJ_DIR)/thread.o $(SRC_BASE)/kernel/libroot/os/thread.cpp

####### linking
	$(CXX) -shared -fPIC -o $(LIB_DIR)/libroot.so \
	$(OBJ_DIR)/nemo_debug.o $(OBJ_DIR)/port.o $(OBJ_DIR)/sem.o $(OBJ_DIR)/thread.o \
	-lpthread

#######  install lib
#	cp -f $(LIB_DIR)/libroot.so /usr/lib

#########################################################################
# TARGET libbe.so
#########################################################################

LIBBE_DEP	:=	libroot \
				$(INCLUDE_BE)/*.h \
				$(INCLUDE_APP)/*.h $(INCLUDE_PRIVATE_APP)/*.h $(SRC_BASE)/kits/app/*.cpp \
				$(INCLUDE_DEVICE)/*.h \
				$(INCLUDE_DRIVERS)/*.h \
				$(INCLUDE_GAME)/*.h \
				$(INCLUDE_INTERFACE)/*.h \
				$(INCLUDE_KERNEL)/*.h \
				$(INCLUDE_MAIL)/*.h \
				$(INCLUDE_MEDIA)/*.h \
				$(INCLUDE_MIDI)/*.h \
				$(INCLUDE_MIDI2)/*.h \
				$(INCLUDE_NET)/*.h \
				$(INCLUDE_STORAGE)/*.h \
				$(INCLUDE_SUPPORT)/*.h $(SRC_BASE)/kits/support/*.cpp \
				$(INCLUDE_TRANSLATION)/*.h \

LIBBE_INCLUDES:=	$(INCLUDE_ALL_BE) $(INCLUDE_ALL_PRIVATE)

libbe: $(LIBBE_DEP)
####### compiling
#	Support Kit
	$(CXX) $(CXXFLAGS) -c -fPIC $(LIBBE_INCLUDES) -o $(OBJ_DIR)/Archivable.o $(SRC_BASE)/kits/support/Archivable.cpp
	$(CXX) $(CXXFLAGS) -c -fPIC $(LIBBE_INCLUDES) -o $(OBJ_DIR)/List.o $(SRC_BASE)/kits/support/List.cpp
	$(CXX) $(CXXFLAGS) -c -fPIC $(LIBBE_INCLUDES) -o $(OBJ_DIR)/Locker.o $(SRC_BASE)/kits/support/Locker.cpp
#	Application Kit
#	$(CXX) $(CXXFLAGS) -c -fPIC $(LIBBE_INCLUDES) -o $(OBJ_DIR)/Handler.o $(SRC_BASE)/kits/app/Handler.cpp
#	$(CXX) $(CXXFLAGS) -c -fPIC $(LIBBE_INCLUDES) -o $(OBJ_DIR)/Looper.o $(SRC_BASE)/kits/app/Looper.cpp
#	$(CXX) $(CXXFLAGS) -c -fPIC $(LIBBE_INCLUDES) -o $(OBJ_DIR)/ObserverList.o $(SRC_BASE)/kits/app/ObserverList.cpp
#	$(CXX) $(CXXFLAGS) -c -fPIC $(LIBBE_INCLUDES) -o $(OBJ_DIR)/TokenSpace.o $(SRC_BASE)/kits/app/TokenSpace.cpp

####### linking
	$(CXX) -shared -fPIC -o $(LIB_DIR)/libbe.so \
	$(OBJ_DIR)/Archivable.o \
	$(OBJ_DIR)/List.o \
	$(OBJ_DIR)/Locker.o \
	-lroot

#######  install lib
#	cp -f $(LIB_DIR)/libbe.so /usr/lib

###########################################
## Code added by Fadi Raafat Rezk EDWARD ##
###########################################


#########################################################################
# TARGET libmedia.so
#########################################################################

LIBMEDIA_DEP	:=	libroot \
			libbe	\
				$(INCLUDE_BE)/*.h \
				$(INCLUDE_APP)/*.h \
				$(INCLUDE_DEVICE)/*.h \
				$(INCLUDE_DRIVERS)/*.h \
				$(INCLUDE_GAME)/*.h \
				$(INCLUDE_INTERFACE)/*.h \
				$(INCLUDE_KERNEL)/*.h \
				$(INCLUDE_MAIL)/*.h \
				$(INCLUDE_MEDIA)/*.h $(INCLUDE_PRIVATE_MEDIA)/*.h $(SRC_BASE)/servers/media/*.h $(INCLUDE_SERVER_MEDIA)/*.h $(SRC_BASE)/kits/media/*.cpp \
				$(INCLUDE_MIDI)/*.h \
				$(INCLUDE_MIDI2)/*.h \
				$(INCLUDE_NET)/*.h \
				$(INCLUDE_STORAGE)/*.h \
				$(INCLUDE_SUPPORT)/*.h \
				$(INCLUDE_TRANSLATION)/*.h \

LIBMEDIA_INCLUDES:=	$(INCLUDE_ALL_BE) $(INCLUDE_ALL_PRIVATE) 

libmedia: $(LIBMEDIA_DEP)
####### compiling
#	Media Kit
	$(CXX) $(CXXFLAGS) -c -fPIC $(LIBMEDIA_INCLUDES) -o $(OBJ_DIR)/MediaNode.o $(SRC_BASE)/kits/media/MediaNode.cpp

####### linking
	$(CXX) -shared -fPIC -o $(LIB_DIR)/libmedia.so \
	$(OBJ_DIR)/MediaNode.o \
	-lbe \
	-lroot

#######  install lib
#	cp -f $(LIB_DIR)/libmedia.so /usr/lib


###########################
## Fadi's code ends here ##
###########################


#########################################################################
# TARGET app_server
#########################################################################

APP_SERVER_DEP	:=	libbe \
			$(SRC_BASE)/servers/app/*.*

APP_SERVER_INCLUDES:=	$(INCLUDE_ALL_BE) $(INCLUDE_ALL_PRIVATE) -I$(SRC_BASE)/servers/app

app_server: $(APP_SERVER_DEP)
####### compiling
	$(CXX) $(CXXFLAGS) -c $(APP_SERVER_INCLUDES) -o $(OBJ_DIR)/AppServer.o $(SRC_BASE)/servers/app/AppServer.cpp
	$(CXX) $(CXXFLAGS) -c $(APP_SERVER_INCLUDES) -o $(OBJ_DIR)/ServerApp.o $(SRC_BASE)/servers/app/ServerApp.cpp

####### linking
	$(CXX) $(CXXFLAGS) -o $(BIN_DIR)/app_server \
	$(OBJ_DIR)/AppServer.o \
	$(OBJ_DIR)/ServerApp.o \
	-lbe

#########################################################################
# TARGET input_server
#########################################################################

INPUT_SERVER_DEP:=	app_server

INPUT_SERVER_INCLUDES:=	$(INCLUDE_ALL_BE) -I$(SRC_BASE)/servers/app

input_server: $(INPUT_SERVER_DEP)
####### compiling
	$(CXX) $(CXXFLAGS) -c $(INPUT_SERVER_INCLUDES) -o $(OBJ_DIR)/input_server.o $(SRC_BASE)/test/input_server.cpp

####### linking
	$(CXX) $(CXXFLAGS) -o $(BIN_DIR)/input_server \
	$(OBJ_DIR)/input_server.o \
	-lroot

#########################################################################
# TARGET test_app
#########################################################################

TEST_APP_DEP	:= 	app_server
TEST_APP_INCLUDES:=	$(INCLUDE_ALL_BE) -I$(SRC_BASE)/servers/app

test_app: $(TEST_APP_DEP)
####### compiling
	$(CXX) $(CXXFLAGS) -c $(TEST_APP_INCLUDES) -o $(OBJ_DIR)/test_app.o $(SRC_BASE)/test/test_app.cpp
####### linking
	$(CXX) $(CXXFLAGS) -o $(BIN_DIR)/test_app \
	$(OBJ_DIR)/test_app.o \
	-lroot

#########################################################################
# Code by fadi and Raymond on the 25/2/2004
#########################################################################

#########################################################################
# TARGET node_test
#########################################################################

MEDIA_TEST_DEP	:= 	libmedia \
			$(INCLUDE_MEDIA)/*.h \
			$(SRC_BASE)/test/media/node_test/*.*
MEDIA_TEST_INCLUDES:=	$(INCLUDE_ALL_BE) \
			-I$(SRC_BASE)/test/media/node_test
			#$(INCLUDE_POSIX) 
#-I$(SRC_BASE)/servers/app

node_test: $(MEDIA_TEST_DEP)
####### compiling
	$(CXX) $(CXXFLAGS) -c $(MEDIA_TEST_INCLUDES) -o $(OBJ_DIR)/nodetest.o $(SRC_BASE)/test/media/node_test/main.cpp
	$(CXX) $(CXXFLAGS) -c $(MEDIA_TEST_INCLUDES) -o $(OBJ_DIR)/ProducerNode.o $(SRC_BASE)/test/media/node_test/ProducerNode.cpp
	$(CXX) $(CXXFLAGS) -c $(MEDIA_TEST_INCLUDES) -o $(OBJ_DIR)/ConsumerNode.o $(SRC_BASE)/test/media/node_test/ConsumerNode.cpp
	$(CXX) $(CXXFLAGS) -c $(MEDIA_TEST_INCLUDES) -o $(OBJ_DIR)/misc.o $(SRC_BASE)/test/media/node_test/misc.cpp
####### linking
	$(CXX) $(CXXFLAGS) -o $(BIN_DIR)/node_test $(OBJ_DIR)/nodetest.o $(OBJ_DIR)/ProducerNode.o $(OBJ_DIR)/ConsumerNode.o -lmedia -lbe -lroot >> debuglog.txt


#########################################################################
# Their code ends here
#########################################################################	


# sem_test
#=========
sem_test:	headers/private/nemo_debug.o \
			src/kernel/libroot/os/sem.o \
			src/kernel/libroot/os/thread.o \
			src/kits/support/Locker.o \
			test/sem_test.o

	${CXX} ${CXXFLAGS} -o test/bin/sem_test \
	headers/private/nemo_debug.o \
	src/kernel/libroot/os/sem.o \
	src/kernel/libroot/os/thread.o \
	src/kits/support/Locker.o \
	test/sem_test.o \
	-lpthread
	make clean_obj

# locker_test
#=========
locker_test:	headers/private/nemo_debug.o \
				src/kernel/libroot/os/sem.o \
				src/kernel/libroot/os/thread.o \
				src/kits/support/Locker.o \
				test/locker_test.o

	${CXX} ${CXXFLAGS} -o test/bin/locker_test \
	headers/private/nemo_debug.o \
	src/kernel/libroot/os/sem.o \
	src/kernel/libroot/os/thread.o \
	src/kits/support/Locker.o \
	test/locker_test.o \
	-lpthread
	make clean_obj

# handler_test
#=========
handler_test:	headers/private/nemo_debug.o \
				src/kernel/libroot/os/sem.o \
				src/kernel/libroot/os/thread.o \
				src/kits/support/Locker.o \
				src/kits/support/List.o \
				src/kits/app/TokenSpace.o \
				src/kits/app/ObserverList.o \
				src/kits/app/Handler.o \
				test/handler_test.o

	${CXX} ${CXXFLAGS} -o test/bin/handler_test \
	headers/private/nemo_debug.o \
	src/kernel/libroot/os/sem.o \
	src/kernel/libroot/os/thread.o \
	src/kits/support/Locker.o \
	src/kits/support/List.o \
	src/kits/app/TokenSpace.o \
	src/kits/app/ObserverList.o \
	src/kits/app/Handler.o \
	test/handler_test.o \
	-lpthread
	make clean_obj

#########################################################################
# TARGET clean
#########################################################################

.PHONEY: clean
clean:
	rm -f $(OBJ_DIR)/* $(LIB_DIR)/* $(BIN_DIR)/*
